<!DOCTYPE html>
<html>
<head>
  <!--
    If you are serving your web app in a path other than the root, change the
    href value below to reflect the base path you are serving from.

    The path provided below has to start and end with a slash "/" in order for
    it to work correctly.

    For more details:
    * https://developer.mozilla.org/en-US/docs/Web/HTML/Element/base

    This is a placeholder for base href that will be replaced by the value of
    the `--base-href` argument provided to `flutter build`.
  -->
  <base href="$FLUTTER_BASE_HREF">

  <meta charset="UTF-8">
  <meta content="IE=Edge" http-equiv="X-UA-Compatible">
  <meta name="description" content="ë°”ì´ë¸”ìŠ¤í”½ - AI ë°œìŒ ì½”ì¹­ìœ¼ë¡œ ì˜ì–´ ì„±ê²½ ì•”ì†¡">
  <!-- ì•± ë²„ì „ (ë¹Œë“œ ì‹œ ìë™ ê°±ì‹ ) -->
  <meta name="app-version" content="BUILD_TIMESTAMP">

  <!-- iOS meta tags & icons -->
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <meta name="apple-mobile-web-app-title" content="ë°”ì´ë¸”ìŠ¤í”½">
  <link rel="apple-touch-icon" href="icons/Icon-192.png">

  <!-- Favicon -->
  <link rel="icon" type="image/png" href="favicon.png"/>

  <title>ë°”ì´ë¸”ìŠ¤í”½</title>
  <link rel="manifest" href="manifest.json">

  <!-- í•œê¸€ í°íŠ¸ í”„ë¦¬ë¡œë“œ -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;600;700&display=block" rel="stylesheet">

  <style>
    /* ê¸°ë³¸ í°íŠ¸ ì„¤ì • */
    html, body {
      font-family: 'Noto Sans KR', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      margin: 0;
      padding: 0;
      background-color: #0F0F1A;
    }

    /* ë¡œë”© í™”ë©´ ìŠ¤íƒ€ì¼ - ì‹œìŠ¤í…œ í°íŠ¸ ê³ ì • ì‚¬ìš© */
    #loading {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      background: linear-gradient(180deg, #3949AB 0%, #5C6BC0 100%);
      z-index: 9999;
      transition: opacity 0.3s ease-out;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif !important;
    }

    #loading.fade-out {
      opacity: 0;
      pointer-events: none;
    }

    #loading-icon {
      width: 64px;
      height: 64px;
      font-size: 64px;
      line-height: 64px;
      text-align: center;
      margin-bottom: 24px;
    }

    #loading-title {
      font-size: 28px;
      font-weight: bold;
      color: white;
      margin-bottom: 8px;
      letter-spacing: 2px;
    }

    #loading-subtitle {
      font-size: 14px;
      color: rgba(255, 255, 255, 0.7);
      margin-bottom: 32px;
    }

    .spinner {
      width: 40px;
      height: 40px;
      border: 3px solid rgba(255, 255, 255, 0.3);
      border-top-color: white;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
  <!-- ë¡œë”© í™”ë©´ -->
  <div id="loading">
    <div id="loading-icon">ğŸ“–</div>
    <div id="loading-title">ë°”ì´ë¸” ìŠ¤í”½</div>
    <div id="loading-subtitle">ì˜ì–´ ì„±ê²½ ì•”ì†¡ íŠœí„°</div>
    <div class="spinner"></div>
  </div>

  <script>
    // ========================================
    // PWA ì—…ë°ì´íŠ¸ ê°ì§€ ì‹œìŠ¤í…œ (iOS Safari ìµœì í™”)
    // ========================================
    window.appUpdateReady = false;
    window.newServiceWorker = null;
    window.currentAppVersion = null;
    window.updateCheckInProgress = false;

    // iOS PWA í™˜ê²½ ê°ì§€
    var isIOSPWA = (function() {
      var isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
      var isStandalone = window.navigator.standalone === true;
      return isIOS && isStandalone;
    })();

    console.log('[PWA] iOS PWA mode:', isIOSPWA);

    // í˜„ì¬ ì•± ë²„ì „ ê°€ì ¸ì˜¤ê¸°
    window.getAppVersion = function() {
      return document.querySelector('meta[name="app-version"]')?.content || 'unknown';
    };

    // version.jsonì—ì„œ ì„œë²„ ë²„ì „ í™•ì¸ (iOS PWA í•µì‹¬!)
    async function checkVersionFromServer() {
      if (window.updateCheckInProgress) return;
      window.updateCheckInProgress = true;

      try {
        // ìºì‹œ ìš°íšŒë¥¼ ìœ„í•´ íƒ€ì„ìŠ¤íƒ¬í”„ ì¶”ê°€
        var response = await fetch('/version.json?t=' + Date.now(), {
          cache: 'no-store',
          headers: { 'Cache-Control': 'no-cache' }
        });

        if (!response.ok) {
          console.log('[PWA] version.json fetch failed:', response.status);
          return;
        }

        var serverVersion = await response.json();
        var currentVersion = window.getAppVersion();

        console.log('[PWA] Version check - Current:', currentVersion, 'Server:', serverVersion.version);

        // ë²„ì „ì´ ë‹¤ë¥´ë©´ ì—…ë°ì´íŠ¸ í•„ìš”
        if (currentVersion !== 'unknown' &&
            currentVersion !== 'BUILD_TIMESTAMP' &&
            serverVersion.version &&
            currentVersion !== serverVersion.version) {
          console.log('[PWA] New version detected via version.json!');
          window.appUpdateReady = true;
          notifyFlutterUpdate();
        }
      } catch (e) {
        console.log('[PWA] Version check error:', e);
      } finally {
        window.updateCheckInProgress = false;
      }
    }

    // ì„œë¹„ìŠ¤ ì›Œì»¤ ì—…ë°ì´íŠ¸ ê°ì§€ ë° ì²˜ë¦¬
    function initServiceWorkerUpdate() {
      if (!('serviceWorker' in navigator)) return;

      navigator.serviceWorker.ready.then(function(registration) {
        // ì—…ë°ì´íŠ¸ í™•ì¸ ê°„ê²© (iOS PWAëŠ” ë” ìì£¼)
        var checkInterval = isIOSPWA ? 30000 : 60000;

        // ì£¼ê¸°ì ìœ¼ë¡œ ì—…ë°ì´íŠ¸ í™•ì¸
        setInterval(function() {
          // ì„œë¹„ìŠ¤ ì›Œì»¤ ì—…ë°ì´íŠ¸ í™•ì¸
          registration.update().catch(function(e) {
            console.log('[SW] Update check failed:', e);
          });

          // version.jsonë„ í™•ì¸ (iOS PWAì—ì„œ ë” ì‹ ë¢°ì„± ìˆìŒ)
          checkVersionFromServer();
        }, checkInterval);

        // ì•± ì‹œì‘ ì‹œ ì¦‰ì‹œ ì—…ë°ì´íŠ¸ í™•ì¸
        registration.update();
        setTimeout(checkVersionFromServer, 2000); // Flutter ë¡œë“œ í›„ í™•ì¸

        // ìƒˆ ì„œë¹„ìŠ¤ ì›Œì»¤ ê°ì§€
        registration.addEventListener('updatefound', function() {
          var newWorker = registration.installing;
          console.log('[SW] New service worker found');

          newWorker.addEventListener('statechange', function() {
            console.log('[SW] State changed:', newWorker.state);

            if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
              // ìƒˆ ë²„ì „ì´ ì„¤ì¹˜ë˜ì–´ ëŒ€ê¸° ì¤‘
              console.log('[SW] New version ready!');
              window.appUpdateReady = true;
              window.newServiceWorker = newWorker;

              // Flutterì— ì—…ë°ì´íŠ¸ ì•Œë¦¼
              notifyFlutterUpdate();
            }
          });
        });
      });

      // ì»¨íŠ¸ë¡¤ëŸ¬ ë³€ê²½ ê°ì§€ (ìƒˆ SWê°€ í™œì„±í™”ë¨)
      navigator.serviceWorker.addEventListener('controllerchange', function() {
        console.log('[SW] Controller changed, reloading...');
        // ìƒˆ ì„œë¹„ìŠ¤ ì›Œì»¤ê°€ ì œì–´ê¶Œì„ ê°€ì ¸ê° - í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨
        if (window.appUpdateReady) {
          window.location.reload();
        }
      });
    }

    // ì•±ì´ ë‹¤ì‹œ foregroundë¡œ ì˜¬ ë•Œ ì—…ë°ì´íŠ¸ í™•ì¸ (iOS PWA í•µì‹¬!)
    document.addEventListener('visibilitychange', function() {
      if (document.visibilityState === 'visible') {
        console.log('[PWA] App became visible, checking for updates...');
        checkVersionFromServer();

        // ì„œë¹„ìŠ¤ ì›Œì»¤ë„ ì—…ë°ì´íŠ¸ í™•ì¸
        if ('serviceWorker' in navigator && navigator.serviceWorker.controller) {
          navigator.serviceWorker.ready.then(function(registration) {
            registration.update();
          });
        }
      }
    });

    // iOS PWA: pageshow ì´ë²¤íŠ¸ë„ ê°ì‹œ (bfcache ëŒ€ì‘)
    window.addEventListener('pageshow', function(event) {
      if (event.persisted || isIOSPWA) {
        console.log('[PWA] Page shown (persisted:', event.persisted, '), checking updates...');
        setTimeout(checkVersionFromServer, 500);
      }
    });

    // Flutter ì•±ì— ì—…ë°ì´íŠ¸ ì•Œë¦¼
    function notifyFlutterUpdate() {
      // ì´ë¯¸ ì•Œë¦¼ ìƒíƒœë©´ ì¤‘ë³µ ë°©ì§€
      if (window.updateNotified) return;
      window.updateNotified = true;

      // Flutterê°€ ë¡œë“œëœ í›„ì—ë§Œ ì•Œë¦¼
      if (window.flutterUpdateCallback) {
        window.flutterUpdateCallback();
      } else {
        // Flutter ë¡œë“œ ëŒ€ê¸°
        window.pendingUpdateNotification = true;
      }
    }

    // ì—…ë°ì´íŠ¸ ì ìš© (Flutterì—ì„œ í˜¸ì¶œ)
    window.applyAppUpdate = function() {
      if (window.newServiceWorker) {
        // waiting ìƒíƒœì˜ SWì— skipWaiting ë©”ì‹œì§€ ì „ì†¡
        window.newServiceWorker.postMessage({ type: 'SKIP_WAITING' });
      } else {
        // fallback: ê°•ì œ ìƒˆë¡œê³ ì¹¨ (ìºì‹œ ì‚­ì œ í›„)
        if ('caches' in window) {
          caches.keys().then(function(names) {
            Promise.all(names.map(function(name) {
              return caches.delete(name);
            })).then(function() {
              console.log('[PWA] Caches cleared, reloading...');
              window.location.reload(true);
            });
          });
        } else {
          window.location.reload(true);
        }
      }
    };

    // ê°•ì œ ìƒˆë¡œê³ ì¹¨ (ìˆ˜ë™ ì—…ë°ì´íŠ¸ìš©)
    window.forceAppRefresh = function() {
      console.log('[PWA] Force refresh requested');
      if ('caches' in window) {
        caches.keys().then(function(names) {
          return Promise.all(names.map(function(name) {
            console.log('[PWA] Deleting cache:', name);
            return caches.delete(name);
          }));
        }).then(function() {
          // ì„œë¹„ìŠ¤ ì›Œì»¤ ë“±ë¡ í•´ì œ í›„ ìƒˆë¡œê³ ì¹¨
          if ('serviceWorker' in navigator) {
            navigator.serviceWorker.getRegistrations().then(function(registrations) {
              Promise.all(registrations.map(function(reg) {
                return reg.unregister();
              })).then(function() {
                window.location.reload(true);
              });
            });
          } else {
            window.location.reload(true);
          }
        });
      } else {
        window.location.reload(true);
      }
    };

    // ì„œë¹„ìŠ¤ ì›Œì»¤ ì´ˆê¸°í™”
    initServiceWorkerUpdate();

    // í˜„ì¬ ë²„ì „ ì €ì¥ (ë””ë²„ê¹…ìš©)
    window.currentAppVersion = window.getAppVersion();
    console.log('[PWA] App version:', window.currentAppVersion);

    // ========================================
    // Flutter ì•± ë¡œë”© ì²˜ë¦¬
    // ========================================
    window.addEventListener('flutter-first-frame', function() {
      // í°íŠ¸ê°€ ë¡œë“œë  ë•Œê¹Œì§€ ì ì‹œ ëŒ€ê¸° í›„ ë¡œë”© í™”ë©´ ìˆ¨ê¸°ê¸°
      var hideLoading = function() {
        var loading = document.getElementById('loading');
        if (loading) {
          loading.classList.add('fade-out');
          setTimeout(function() {
            loading.style.display = 'none';
          }, 300);
        }
      };

      // í°íŠ¸ ë¡œë“œ ì™„ë£Œ ëŒ€ê¸° (ìµœëŒ€ 500ms)
      if (document.fonts && document.fonts.ready) {
        document.fonts.ready.then(function() {
          setTimeout(hideLoading, 100);
        }).catch(function() {
          setTimeout(hideLoading, 100);
        });
      } else {
        setTimeout(hideLoading, 500);
      }

      // ëŒ€ê¸° ì¤‘ì¸ ì—…ë°ì´íŠ¸ ì•Œë¦¼ ì²˜ë¦¬
      if (window.pendingUpdateNotification && window.flutterUpdateCallback) {
        window.flutterUpdateCallback();
      }
    });
  </script>

  <script src="flutter_bootstrap.js" async></script>
</body>
</html>
